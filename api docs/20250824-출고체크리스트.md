# 2025-08-24 – 주간 출고 체크리스트(풀스택/전역동기화 + 관리자)

본 문서는 2025-08-25(월) 착수 → 2025-08-29(금) 카나리 배포를 목표로 하는 풀스택/전역동기화 작업과 관리자 기능(Shop Toggle)까지 포함한 출고 체크리스트입니다. 스택: FastAPI/Next.js/PostgreSQL/Redis/Kafka, 실행: docker-compose, 표준: app.core.config.settings, Alembic 단일 head 유지.

## 범위 및 전제
- 범위: 프론트 ESLint 차단, 게임3종+EventMissionPanel 셀렉터/WS 일원화, Admin Shop 활성/비활성 토글 API, streak 스모크 가속, 이벤트 진행도 WS 전환, Alembic 단일 head 재검증, 모니터링 임계 튜닝, OpenAPI 재수출/문서 동기화.
- 전제: 컨테이너 내부에서 빌드/테스트/마이그레이션 실행, /docs 정상, `alembic heads` 단일 유지.

## 진행도 업데이트(2025-08-25)
- 모니터링/알림
  - Prometheus 룰 파싱 오류 복구 완료. `purchase-health` 4개, `kafka_consumer_health` 2개 규칙 로드 확인, `/targets` up.
  - Kafka Exporter up, Grafana Consumer Lag 패널 동작 확인.
  - Pending 스파이크 임계 ENV 외부화 및 템플릿 렌더 파이프라인 적용 완료(템플릿/렌더 Done, .env.* 값 분리 적용 To-do).
- 런타임/헬스
  - 컨테이너 no-cache 재빌드/기동 완료. `/health` 200, `/docs` 200 확인.
  - Alembic heads 단일 유지 확인: 컨테이너 기준 `c6a1b5e2e2b1 (head)`.
- 테스트/품질
  - 제한/결제 스모크 GREEN: `test_limited_holds_and_concurrency.py`(2), `test_shop_buy.py`(4), `test_limited_packages*.py`(3) 합계 9 테스트 통과.
  - 경고(passlib crypt, Pydantic v2 ConfigDict 안내)는 무해, 기능 영향 없음.
- WS/메트릭 검증
  - 레거시 WS 카운터 노출 및 증가 확인: `/metrics`에서
    - `ws_legacy_games_connections_total` 0→1 증가,
    - `ws_legacy_games_connections_by_result_total{result="rejected"}` 1 증가(WS 비활성 상태에서 스크립트 1회 터치).
  - `{result="accepted"}` 검증은 레거시 WS 활성 후 재확인 예정.
- 브랜치/기준 정렬
  - 업스트림 기준 커밋 `7c07a00`에서 `merge/upstream-base-7c07a00` 브랜치 정렬 및 푸시 완료.
  
메모
- 로컬 오버라이드 `docker-compose.override.local.yml`에 코드펜스 포함 등 포맷 오류가 있어 ENV 오버라이드가 일부 적용되지 않을 수 있음 → 별도 PR로 YAML 정상화 예정(backend.environment 하위에 `ENABLE_LEGACY_GAMES_WS` 배치).
- 테스트/품질
  - OpenAPI 스모크(수동 재수출 기준) OK, Alembic head 단일 유지.
  - 컨테이너 내부 pytest 스모크(결제/스트릭) 실행 To-do(오늘 수행 예정).
- 자동화/문서
  - OpenAPI 재수출 자동화 + PR Diff 코멘트 워크플로 연계 To-do(8/27 동시 반영 목표).

## 전체 체크리스트(요약)
- 프론트엔드
  - [ ] ESLint: 문자열 '/api/users/profile' 사용 금지(대안 안내: '/api/users/me').
  (메모: 규칙 적용 완료, 위반 0화 대상 코드 스캔 예정)
  - [ ] Crash/Slot/Gacha/EventMissionPanel → RealtimeSyncContext + selector(useGold/useStats/useEvents) 완전 전환.
  - [ ] 폴백 폴링 간격 표준화(WS 우선, 폴백 30s 권장).
  - [ ] FE 스모크: 로그인→골드 반영→게임 액션→통계/이벤트 배지 일관성.
- 백엔드
  - [ ] Admin Shop Toggle API: PATCH /api/admin/shop/items/{id}/toggle(active: bool)
  - [ ] RBAC(ADMIN), 멱등, 감사로그, OpenAPI, 테스트(200/403/409) 포함.
  - [ ] streak 테스트 가속(슬립/Redis 경로 최적화) + 타임아웃 가드.
  - [ ] 이벤트 진행도 WS 전환: join/claim/진행 시 `event_progress` 브로드캐스트.
  - [ ] Alembic heads 단일성 재검증(필요 시 merge 리비전 생성).
- 모니터링/운영
  - [ ] 구매 성공률/지연 임계(p95/p99) ENV 분리(dev/stage/prod), pending 스파이크 임계 환경별 분리.
    (메모: pending 스파이크 임계 ENV 템플릿/렌더 적용 완료, .env.* 프로파일 값 분리/튜닝은 진행 필요)
  - [ ] OpenAPI 재수출 주기화(컨테이너 내부) + 스냅샷/가이드 자동 갱신.
    (메모: 수동 스모크 OK, CI 연계/PR 코멘트 자동화는 To-do)
  - [ ] Grafana 패널(game_stats_update_latency_ms 포함) 점검.
- 관리자(프론트/백엔드 연계)
  - [ ] Admin Shop 화면에 활성/비활성 토글 UI 추가 및 API 연동.
  - [ ] 권한 오류/감사로그 결과 토스트 표준화, 최근 관리 작업 이력 노출.
- 전역 동기화(WS/SSE)
  - [ ] `purchase_update`/`profile_update`/`stats_update`/`event_progress` 스키마 재확인.
  - [ ] 프론트 공용 WS 핸들러 연결 및 배지/토스트 표준화.
  - [ ] WS 재연결/오프라인 폴백 시나리오 재검증.

## 일별 계획과 Exit Criteria
- 8/24(일) D-1 준비
  - [ ] 컨테이너 상태/헬스 확인, /docs 스키마 최신 여부 확인.
  - [ ] 작업 브랜치/릴리즈 노트 초안/롤백 체크리스트 준비.
  - Exit: /health 200, /docs 정상, 작업 브랜치 준비.
- 8/25(월) 프론트 집중
  - [ ] ESLint 금지 규칙 적용 및 위반 0화.
  - [ ] 게임3종+EventMissionPanel 셀렉터/WS 일원화, 폴백 표준화.
  - [ ] FE 스모크 업데이트.
  - Exit: FE 빌드 PASS, ESLint 위반 0, 4화면 스모크 100%.
- 8/26(화) 백엔드 기능 + 마이그레이션 안정화
  - [ ] Toggle API 구현(RBAC/감사로그/멱등/OpenAPI/테스트).
  - [ ] streak 가속/타임아웃, 이벤트 진행도 WS 전환.
  - [ ] Alembic heads=1 유지(필요시 merge 생성).
  - Exit: pytest 주요 스위트 PASS, heads=1, /docs 정상, Toggle 200/403/409 통과.
- 8/27(수) 모니터링/문서/스키마 동기화
  - [ ] 임계 튜닝(SLO≥99.5%, p95<400ms, p99<800ms) ENV 프로파일 분리.
  - [ ] pending 스파이크 임계 환경별 분리, 렌더 스크립트 재적용.
  - [ ] OpenAPI 재수출 파이프라인/스냅샷/가이드 자동 갱신.
  - Exit: Grafana 패널/알림 룰 로드, OpenAPI 스냅샷 최신, 문서 반영.
- 8/28(목) 스테이징 Soak/성능·보안 점검
  - [ ] 1~2시간 합성 부하, p95/p99/에러율 관찰.
  - [ ] WS 재연결/토큰 회전/멱등 재시도 시나리오 검증.
  - [ ] RBAC/감사로그/웹훅 서명/백업·롤백 리허설.
  - Exit: SLO 충족, 경보 무폭주, 멱등 보장, 롤백/런북 체크리스트 서명.
- 8/29(금) 릴리스 후보 확정/프로덕션 배포
  - [ ] Go/No-Go 확인(변경/테스트/알림/런북).
  - [ ] 단계적 배포(10%→50%→100%) + 15분 스모크.
  - Exit: 배포 후 1시간 안정화, 에러율/지연/구매성공률 SLO 내.

## 관리자 기능 상세(Shop Toggle)
- API: `PATCH /api/admin/shop/items/{id}/toggle` Body `{ "active": true|false }`
- 요구사항: ADMIN RBAC, 멱등, 감사로그(Event: ADMIN_SHOP_TOGGLE, actor, item_id, old→new, reason?), OpenAPI 문서화, 테스트 케이스(200/403/409/404).
- 프론트: Admin Shop Manager에 토글 버튼/모달, 결과 토스트/배지, 최근 관리 작업 패널 업데이트.

## 전역 동기화 이벤트 스키마(재확인)
- purchase_update: `{ status, product_id?, receipt_code?, amount?, reason_code? }`
- profile_update: `{ gold|gold_balance, xp?, tier? }`
- stats_update: `{ games_played, win_rate, ... }`
- event_progress: `{ event_id, progress, can_claim, ... }`

## 품질 게이트 & 검증 루틴
- Build/Lint/Tests: FE 빌드 PASS, ESLint 0; BE pytest PASS; 타입 오류 0.
- DB: `alembic heads` 단일 유지, upgrade head 성공.
- 런타임: /health 200, /docs 정상 노출, 핵심 API 401→로그인→200 흐름.
- SLO: 성공률≥99.5%, p95<400ms, p99<800ms, 구매 실패율<1%.

## 리스크 & 완화
- Alembic 다중 head: 즉시 merge 리비전 생성 후 재검증.
- WS 통합 리그레션: 셀렉터 기반 e2e 스냅샷, 폴백 폴링 유지.
- 성능 튜닝 미흡: 임계 보수화, 비동기/캐시 TTL 단기 조정.

## 배포(카나리) 개요
- 10% → 50% → 100% 단계 전개, 단계 간 15분 스모크(로그인/구매/게임/이벤트/프로필).
- 실패 시 즉시 롤백, 데이터 백업 스냅샷 및 런북에 따른 복구.

## 산출물/문서
- OpenAPI 재수출: 컨테이너 내부 `python -m app.export_openapi`(파이프라인화).
- 문서 갱신: `api docs/20250808.md` 및 본 문서에 변경 요약/검증/다음 단계 반영.


판단 기준(라벨)
Full: FE+BE+WS(실시간)까지 일관 동작
Partial: 일부 누락(FE-only/BE-only/WS 미연동 등 사유 표기)
Planned: 문서/체크리스트만 존재, 구현 대기
사용자 여정(End-to-End)
온보딩/로그인 → 대시보드 로드 → WS 연결(initial_state) → 프로필/골드/통계 로드(selectors) → 게임 플레이(크래시/가챠) → 구매/정산(멱등, WS 반영) → 이벤트 진행/클레임(리스트/진행도) → 통계/배지 실시간 갱신 → 관리자(할인/랭크/통계) 운영 → 모니터링·알림 관찰
기능별 상태 요약
인증/세션

/api/auth/signup, /api/auth/login, /api/auth/me, 락아웃(5회/10분): Full
프론트 토큰/리프레시+지수백오프(unifiedApi): Full
프로필/골드

/api/users/me 표준화, gold/gold_balance 호환, WS profile_update: Full
프론트 전역 selector(useGold) 정착(주요 화면 대부분): Partial(일부 게임 화면 마이그레이션 마무리 예정)
상점/결제

/api/shop/catalog, /api/shop/buy(멱등키 재시도), /settle, WS purchase_update(+성공 시 profile_update): Full
프론트 Shop/Admin 화면 실사용 연동: Full
Admin 할인/랭크 PATCH: Full
Admin 활성/비활성 Toggle API: Planned(이번 주 구현 예정)
보상(Rewards)

/api/rewards/distribute 후 WS reward_granted+profile_update 브로드캐스트: BE=Full, FE=Partial(전용 UI는 일부 화면 연동 단계)
게임

Crash: 세션/정산, stats_update 브로드캐스트, 프론트 화면 존재: Partial(FE 셀렉터/WS 일원화 마무리 남음, 플레이·정산 동작은 OK)
Gacha: /api/games/gacha/pull 통합, 프론트 컴포넌트 존재: Partial(FE 셀렉터 전환 마무리 남음)
Slot: 프론트 UI 존재, BE 가변보상/피드백 API는 제한 사용: Partial(FE 동작, BE 룰 정합성/표준화 추가 필요)
RPS: 데모/학습 목적 구성 수준: Partial(확장 전)
사용자 통계/게임 통계

/api/games/stats/me 정적 경로 우선 해결, WS stats_update, 대시보드/카드 반영: Full
이벤트/미션

/api/events/active 200 복구, 프론트 refreshEvents로 전역 상태 반영: Partial
event_progress WS 브로드캐스트(조인/클레임/진행): Partial(서버 일부 경로 반영, 통합 일원화 이번 주 완료 예정)
EventMissionPanel 셀렉터/WS 전환: Partial(이번 주 대상)
스트릭(Streak)

tick/history/protection 엔드포인트, 테스트 존재: BE=Full
테스트 가속/타임아웃 가드: Planned
프론트 배지/진행 UI: Partial
관리자 기능(Admin)

Admin Shop 할인/랭크 PATCH(권한/검증/UX): Full
Admin Stats 확장(online_users/revenue/pending/alerts): Full
Admin Shop 활성/비활성 Toggle: Planned(백엔드+프론트 UI 동시 반영 예정)
감사로그 표준: Partial(핵심 경로 기록, Toggle 도입 시 이벤트 추가)
실시간/동기화

/api/realtime/sync 허브, initial_state, purchase_update/profile_update/stats_update: Full
공용 핸들러/배지/토스트 표준화: Partial(이벤트 진행/보상 일부)
오프라인 폴백(폴링): Full(주요 경로 폴백 규약 있음)
글로벌/관리자 메트릭

/api/metrics/global, /api/metrics/stream(SSE): Full
Admin Stats 캐시/쿼리: Full
모니터링/알림

Prometheus 룰 템플릿(ENV 임계), Grafana 대시보드, Kafka Exporter: Full
game_stats_update_latency_ms 히스토그램, HTTP 5xx/P95 경보: Full
임계 운영값 튜닝(dev/stage/prod): Planned(8/27 목표)
스키마/마이그레이션

Alembic 단일 head 유지(테스트 스택), 메인 재검증 필요 시 merge: Partial(검증 주기화 필요)
OpenAPI 재수출 파이프라인, 이벤트 중복 제거: Full(정기화 Planned)
문서/자동화

cc-manage.ps1 도커 관리/헬스/테스트/툴즈, .env 자동 생성: Full
api docs 주간 체크리스트/가이드 최신화: Full
End-to-End 대표 플로우별 판정
로그인 → WS 연결 → 프로필/골드 로드 → 게임(Crash/Gacha) 플레이 → 보상/정산 → 잔액/통계 실시간 반영 → 이벤트 진행 표시

상태: Partial~Full(핵심은 작동, 이벤트 진행 WS·일부 셀렉터 전환 마무리 필요)
상점 구매(멱등 재시도) → 정산/웹훅 → purchase_update + profile_update → 잔액/배지 갱신

상태: Full
관리자: 상점 항목 할인/랭크 변경 → UI 즉시 반영(Optimistic) → 서버 확정/롤백

상태: Full
관리자: 상점 항목 활성/비활성 토글

상태: Planned(이번 주 구현)
운영: 알림 룰/대시보드 관측, SLO(성공률/지연) 체크, OpenAPI 스냅샷 동기화

상태: Partial~Full(임계 분리·주기화 작업 남음)
빠른 결론
지금 바로 “작동” 가능한 핵심: 인증/프로필, 구매/정산 멱등+WS, 통계/프로필 실시간 반영, 관리자 할인/랭크, 글로벌/관리자 메트릭, 모니터링/대시보드.
이번 주 마무리 대상: 게임 화면 셀렉터/WS 일원화, 이벤트 진행 WS, 스트릭 테스트 가속, Admin Toggle API, 임계값 프로파일 분리, Alembic head 재검증 주기화.
전반 평정: 주요 과금/실시간/관측은 Full, 게임/이벤트 UI 일원화와 일부 관리자 토글은 Partial/Planned. 배포 게이트 충족은 8/29 목표 일정으로 현실적.


런타임/헬스
컨테이너 기동 상태 확인 → 백엔드 /health 200, docs 200.
프로덕션 배포 시 로컬 오버라이드 포트 매핑 제외(docker-compose.prod.yml 우선).
DB/Alembic
컨테이너 내부에서 alembic heads 단일 확인(현재 기준 head: c6a1b5e2e2b1) → alembic upgrade head.
DB 백업 1회 수행 후 진행.
테스트 스모크(백엔드)
결제/한정 패키지 스위트만 재실행:
app/tests/test_limited_holds_and_concurrency.py
app/tests/test_shop_buy.py
app/tests/test_limited_packages*.py
전체 GREEN 확인(경고 무시 가능 범위인지만 체크).
OpenAPI
컨테이너 내부에서 재수출 → 스냅샷 반영(필요 시 커밋).
docs 스키마 노출 정상 재확인.
모니터링/메트릭
Prometheus 타깃 up, 알림 룰(purchase/HTTP 5xx/p95) 로드 확인.
/metrics에서 핵심 지표 노출 확인:
ws_legacy_games_connections_total
ws_legacy_games_connections_by_result_total{result="accepted"|"rejected"}
레거시 WS 검증:
운영에선 기본 비활성(ENABLE_LEGACY_GAMES_WS="0").
사전 검증 환경에서만 활성 후 accepted/rejected 각각 1회 유도 → 카운터 증가 확인.
구성/ENV
.env.production 비밀/키 재확인: JWT_SECRET_KEY, API_SECRET_KEY, DB/Redis/Kafka 비밀번호.
성능 임계 p95/p99 값 프로드 프로파일로 적용.
레거시 WS 의도 확정: 미사용이면 ENABLE_LEGACY_GAMES_WS="0" 유지.
프론트엔드
FE 빌드 PASS, ESLint 위반 0.
스모크: 로그인 → 대시보드 로드 → 구매 모의 1회 → 잔액/배지 반영 확인.
배포(카나리)
10% → 50% → 100% 단계 전개, 단계별 15분 스모크(로그인/구매/게임/이벤트/프로필).
각 단계에서 에러율·p95/p99·SLO 확인, 이상 시 즉시 롤백.
문서 동기화
api docs/20250824-출고체크리스트.md, api docs/20250808.md(및 20250823_GLOBAL_EVAL_GUIDE.md)에:
변경 요약(1–3줄), 검증 결과(테스트/heads/OpenAPI), 다음 단계(2–3개) 업데이트.
참고

로컬 오버라이드(docker-compose.override.local.yml)는 운영 배포에 포함하지 말고, 레거시 WS 검증용으로만 사용하세요(backend.environment 하위에 ENABLE_LEGACY_GAMES_WS 배치).