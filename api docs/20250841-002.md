# MVP 출시 우선순위 정리 (배틀패스/성인콘텐츠 제외)

## 0. 범위 정의
- 제외: 배틀패스 전 기능, AdultContent 관련 전 기능, 심리 측정 퀴즈, 실시간(WebSocket/라이브 통계), 업적/리더보드/소셜, 고급 프로모션/한정 패키지(선택 연기).
- 목표: 인증 → 코어 게임(슬롯/가챠) → 행동로깅 → 보상/통화 → 상점/구매 → 기본 대시보드 폐쇄 루프 안정화.

## 1. MUST (출시 전 필수)
### 1.1 인프라 & 안정성
- ⚠️ 주요 테이블/인덱스/제약조건 설계 확정 (1차 감사/제안 완료 → 마이그레이션 적용 중)
- ✅ 백업/복구 전략 수립 + 스크립트/Runbook 작성 (실제 복구 스모크 예정)
- ✅ 로깅 설정 (구조화 JSON + request_id/user_id contextvars 적용)
- ✅ 에러 핸들링 미들웨어 (표준 오류 스키마 + 도메인/HTTP/Validation 통합)
- ✅ 사용자 정의 예외 클래스 (AuthError, AuthorizationError, NotFoundError 등 도입)
- ✅ API 문서화(OpenAPI export: canonical + timestamped snapshot 생성 스크립트)

### 1.2 인증/사용자
- [✅] JWT 인증 및 권한 관리 (초대코드/닉네임 기반, VIP 필드 존재만) — /api/auth/signup, /api/auth/login 추가, HS256 JWT 발급
- [✅] 초기 사용자 설정 (등급 STANDARD, 초기 cyber_token_balance=200)
- [✅] 코드 보안: DEFAULT_INVITE_CODE 난수화 & 환경변수화 (미지정 시 프로세스별 난수 생성 + 로그 경고)
	- 추가 플래그: ENFORCE_DB_INVITE_CODES=1 설정 시 DB 등록 코드(또는 UNLIMITED_INVITE_CODE=5858)만 허용
	- Unlimited 코드(운영 정책): UNLIMITED_INVITE_CODE 기본값 5858 은 '의도적으로 **영구 허용**되는 초기 운영용 마스터 초대 코드'로 정의됨. 이는 다음 조건을 충족해야 함:
		1) 모든 환경(.env / Secret Manager)에서 값이 명시적으로 추적되며, 변경 시 배포 릴리스 노트 기록
		2) 보안 로그에서 5858 사용 가입 건 주기적(예: 일/주 단위) 집계 모니터링
		3) 일반 사용자용 공개 UI/문서에 해당 코드 직접 노출 금지 (운영/QA 내부 공유 전용)
		4) 회전(Rotation) 권고: MVP 안정 후(예: 사용자 1k+ 시점) 신규 난수형(6~8자 영숫자) 코드 생성 → 기존 5858 사용 중단 공지 (Grace 기간 ≥7일) → ENFORCE_DB_INVITE_CODES 활성화 전환
		5) ENFORCE_DB_INVITE_CODES 활성화 시 5858 을 DB에 whitelist 레코드로 명시적으로 저장하거나 아예 운영 종료 여부 결정
	- Rotation 체크리스트 (준비 템플릿):
		- [✅] 5858 사용량(최근 30일) 분석 / 리포트 아카이빙 (INVITE_5858_USAGE_REPORT_20250817.md 생성)
		- [✅] 코드 전환 릴리스 태그 + 문서(CHANGELOG / RELEASE_NOTES) 업데이트 (태그 생성 예정 단계 아래 기록)
		- [✅] 모니터링 알람 규칙(허용되지 않은 마스터 코드 시도) 활성화 (invite_code_alerts.yml 추가)
	- Rotation Runbook (실행 절차 상세):
		
	
### 1.3 코어 게임 루프 & 피드백
- [✅] SlotMachineComponent 서버 연동 완료 (POST /api/games/slot/spin → 서버 권위 + 네트워크 실패 시 로컬 RNG 폴백 유지)
- [✅] GachaSpinComponent 서버 연동 완료 (POST /api/games/gacha/pull 단/10연; pull_count 파라미터; 서버 아이템 변환 → UI; 실패 시 기존 클라이언트 시뮬레이션 폴백)
- [✅] 피드백 알림 시스템 (FeedbackProvider + useFeedback 훅 + 조건부 토스트 렌더) ※ 디자인 영향 없음 (DOM 삽입: 토스트 존재 시만)
- [🟡] 사용자 행동 로깅 API (DB 기록) — 슬롯/가챠 서버 호출 경로 확보됨 → 다음 단계: 표준 ActionLog 스키마 확정 & GameService emit 확장 (Kafka→OLAP 연동은 이후)
	- 추가 메모: 토큰 획득/차감 authoritative balance 반영 준비 완료, 임시 useAuthToken 훅 도입(만료/회전 T.B.D.)

### 1.4 게임 데이터/통계
## 1.5 프론트엔드 API 기본 URL 구성
Frontend API Base URL Fix: ✅ Added normalization to prevent duplicate /api/api calls; ensure NEXT_PUBLIC_API_URL should typically NOT include trailing slash. If backend routers already include /api prefixes (they do), you may set NEXT_PUBLIC_API_URL to just protocol+host[:port] (e.g. http://localhost:8000) OR include single /api (http://localhost:8000/api). Mixed configurations previously caused silent 404 due to /api/api duplication; now auto-normalized with a console warning.
- [✅] 게임별 상세 통계 구현
- [✅] 게임 히스토리 조회 기능
- [✅] WebSocket 연동 (RealtimeHub /api/games/ws, /api/games/ws/monitor 구현 및 테스트 통과)
- [✅] 실시간 게임 세션 모니터링 (monitor snapshot + 이벤트 브로드캐스트 기본형 완료)

- [✅] 푸시 알림 연동 (업적 unlock 알림 + WS 이벤트)
- [✅] 업적 시스템 구현 (모델/마이그레이션/서비스/엔드포인트/평가 훅)



## 관리자 기능 점검 결과 (요약)

### 1.5 상점/과금
- [✅] 상점 상품 표시 (/api/shop/catalog 기본 상품/패키지 노출) ※ 기본 패키지/제한 패키지 코드 존재
- [🟡] 구매 로직 멱등 처리: Redis 기반 + 모델 UniqueConstraint(user_id,product_id,idempotency_key) 적용 (Alembic 반영 대기)
- [✅] 프로모션 관리: 기본 구매/할인 계산/예약(hold) 구현 O
- [🟡] 통화 이원화: 단일 `cyber_token_balance` 유지 결정 (regular_coin_balance / premium_gem_balance 컬럼은 alias 용도로만 존치, 로직 미사용)
- (선택) 한정 패키지 / 운영 UI/상세 정책 LATER 이동

GAP 요약(업데이트 2025-08-17 단일 통화 확정):
1) (취소) 통화 이원화: 현재 계획 보류 – 추후 필요 시 재설계. 남은 dual 컬럼은 제거/nullable 전환 후속 결정 필요.
2) 멱등성: 모델 레벨 Unique 존재 → Alembic migration 생성/적용 필요 + 재시도 충돌 테스트 추가
3) CurrencyService: 단일 통화 모드 전환 완료 (coin/gem/token 모두 동일 값) → 동시성/부족/실패 케이스 테스트 미비
4) 테스트: 성공/중복 구현됨. 잔액부족 / 결제실패 재시도 / pending→retry / 동시성(idempotency_key race) 추가 필요

### 1.6 프론트 사용자 여정
- [ ] 랜딩 페이지 (Hero + 초대코드 진입)
- [ ] 초대코드 입력 화면
- [ ] 회원가입/로그인 모달
- [ ] 온보딩 튜토리얼 (2~3 스텝 최소)
- [ ] 홈 대시보드 (잔액/최근 보상/슬롯·가챠 진입)

### 1.7 테스트 (최소 품질 게이트)
- [❌] 단위 테스트 핵심(인증, 구매, 게임 보상, 행동 로깅)
- [❌] 통합 테스트: 온보딩→슬롯/가챠→구매→잔액 검증 흐름

### 1.8 VIP (표시 최소)
- [ ] VIP 등급 표시(읽기) — 업그레이드 로직 세부는 SHOULD/LATER

## 2. SHOULD (시간 남으면)
- [⚠️] 백업/복구 스크립트(ps1) 고도화 & 자동화 체크
- [⚠️] 특별 보상 처리(이벤트/프로모) 기본 enum 설계
- [⚠️] 출석 달력 데이터 모델(엔드포인트/캘린더 UI 제외)
- [⚠️] 보호/복구 옵션(스트릭 보호) 컬럼/플래그 예약
- [ ] VIP 혜택/업그레이드 UI 보강(비교표, 진행률 바)
- [ ] 피드백 메시지/애니메이션 키 세분화 맵핑
- [ ] 개인화된 추천 UI 스켈레톤 (빈 데이터 시 placeholder)
- [ ] 추천 API 엔드포인트 스켈레톤(200 + TODO 주석)

## 3. LATER (MVP 이후)
- Kafka→OLAP 실시간 행동 분석 파이프라인
- 로그 압축/아카이빙
- 스트릭 레벨/복구 혜택 UI
- 세그먼트 기반 추천 실제 알고리즘 & 사이버 토큰 미션
- RFM 배치/세그먼트 히스토리 추적
- Capture 다중 재시도 정책 파라미터화 / 부분 환불 보정 로직
- VIP 업/다운그레이드 정책 & 자동화
- 온보딩 확장형 튜토리얼/고급 효과
- 고급 프로모션/한정 패키지 로테이션
- WebSocket 실시간 모니터링 / 라이브 통계 / 푸시
- 업적 시스템 / 배지 UI / 리더보드 / 소셜 기능
- 성능 최적화(고빈도 액션 샤딩, 캐시 계층화)

## 4. DROP / EXCLUDE (현 스코프 제외)
- 영수증 발행 및 기록 (🚫)
- AdultContent 관련 모든 항목 (StageComponent, 퀴즈, UI/API)
- 배틀패스 전체 기능
- 심리 측정 퀴즈(제출/분석 API + UI)

## 5. 수량 개요 (상위 MUST)
| 영역 | MUST 항목 수(상위) |
|------|------------------|
| 인프라/안정성 | 6 |
| 인증/사용자 | 3 |
| 코어 게임 & 피드백 | 4 |
| 게임 데이터/통계 | 2 |
| 상점/과금 | 3~4 |
| 프론트 여정 | 6 |
| 테스트 | 2 |
| VIP 표시 | 1 |
| 합계 | 약 27 |

## 6. 실행 순서 (추천 스프린트 흐름)
1) DB 스키마 & 제약조건 확정 → 초기 마이그레이션 / Alembic 단일 head 유지
2) 인증 + 사용자 초기값 + 초대코드 난수화
3) 슬롯/가챠 서비스 & 보상 계산 + 행동 로깅 API (DB)
4) 상점/구매 트랜잭션 + 화폐 시스템 → 홈 대시보드 연결
5) 프론트 온보딩 흐름(랜딩→가입/로그인→튜토리얼→게임 진입)
6) 로깅/에러/예외 + OpenAPI 정비
7) 핵심 단위/통합 테스트 및 CI 기준 잠금
8) 백업 스모크 & VIP 표기 마감 → MVP 태그

## 7. 완료 정의(Definition of Done) 체크
- 인증/구매/슬롯/가챠/피드백/로깅/데이터 저장 End-to-End 테스트 통과
- 마이그레이션: alembic heads 단일 유지 + downgrade 스모크
- OpenAPI 최신화(`current_openapi.json`) 반영
- 백업 덤프/복구 1회 성공 로그 기록
- 핵심 경로 테스트 커버리지 ≥60~65% (향후 80% 목표 에스컬레이션)

---
(원본 상세 목록은 재분류·축약됨. 세부 하위 태스크는 이 문서 기반으로 Issue/Ticket 생성 권장.)

---
### 추가: 코어 게임 통합 작업 요약 (2025-08-17)
변경 요약:
- 슬롯/가챠 모두 서버 권위 호출 + 실패 시 로컬 폴백 패턴 확립
- 공통 피드백 fromApi 경로 적용으로 메시지/애니메이션 훅 단일화
- 임시 토큰 획득 훅(useAuthToken) 도입 → 후속 만료/회전 처리 예정

검증 결과:
- 프론트 TypeScript 오류 0 (NeonSlotGame / GachaSystem 수정 후 tsc 통과 범위 내 확인)
- 문서(본 파일 1.3 섹션) 최신화, OpenAPI 엔드포인트 기존 /api/games/slot/spin /api/games/gacha/pull 사용
- 폴백 경로 수동 테스트(네트워크 예외 시 로컬 RNG 유지) 설계 반영

다음 단계:
1) 사용자 행동 로깅 API 표준화 (액션 타입/보상/세션ID 스키마) + GameService emit 확정
2) 토큰 훅 고도화 (만료/자동 재발급 + 401 재시도)
3) 피드백 severity/animation → UI 아이콘/효과 매핑 테이블화

---
### (2025-08-17 후속 적용 완료 사항)
| 항목 | 상태 | 설명 |
|------|------|------|
| 사용자 액션 로깅 표준화 | 완료 | `_log_user_action` 헬퍼 도입, envelope `{v,type,ts,data}` JSON 직렬화. slot/gacha/rps/crash 엔드포인트 적용.
| 토큰 만료/재발급 1차 | 완료 | `useAuthToken` → `decodeJwtExp`, `isExpired`, `getValidAccessToken` (만료 시 `/api/auth/refresh` POST 시도, 실패시 기존 토큰 유지) 추가.
| 401 자동 재시도 | 완료 | `useApiClient` 401 응답 시 refresh 후 1회 재시도.
| 피드백 시각 매핑 | 완료 | `FeedbackContext`에 `resolveFeedbackVisuals` 매핑: code/severity→Lucide icon + animation 기본값.

#### 액션 로그 예시
```json
{
	"v": 1,
	"type": "GACHA_PULL",
	"ts": "2025-08-17T12:34:56.789Z",
	"data": {
		"game_type": "gacha",
		"pull_count": 10,
		"rare_count": 2,
		"ultra_rare_count": 1,
		"anim": "legendary",
		"items_sample": [ { "name": "Rare Item", "rarity": "rare" } ]
	}
}
```

#### 피드백 코드 매핑 (발췌)
| 코드 prefix | 아이콘 | 애니메이션 |
|-------------|--------|------------|
| slot.jackpot | trophy | jackpot |
| slot.win | star | pulse |
| gacha.pity | sparkles | pity |
| gacha.near_miss | zap | near_miss |
| gacha.win.legendary | trophy | legendary |
| gacha.win.epic | star | epic |

#### 남은 개선 제안
1. Refresh API 스펙 확정 (실패 코드/재시도 한계) + 실패 시 세션 정리 & 로그인 모달.
2. `_log_user_action` 후크에 Kafka publish (commit 후) 옵션 추가.
3. Feedback animation CSS (data-anim 기반 keyframes) + 접근성 보강(aria-live assertive 조건부).
4. 서버 응답에 `net_change` 표준 필드 포함 (클라이언트 계산 감소).

#### (신규) Refresh 토큰/세션 관리 지침
| 항목 | 규칙 | 비고 |
|------|------|------|
| 만료 임계 | exp - 60s 시도(프론트 스케줄) | 최소 10s 안전 버퍼 |
| 재시도 한계 | 1회 즉시 + 1회 지연(3s) = 최대 2회 | 둘 다 실패 시 강제 로그아웃 |
| 실패 처리 | access 토큰 제거 + 사용자 상태 null + 로그인 모달 트리거 | 보안상 토큰 보존 금지 |
| 서버 응답 | 401 + `{detail:"token_expired"}` → 클라이언트 refresh 진입 | 기타 401은 일반 오류 |
| 동시 요청 | `refreshingRef` Promise 공유로 중복 호출 방지 | 완료 후 null 처리 |
| 회전 정책 | refresh 토큰도 교체 시 새 refresh_token 수신 시 저장 | 회전 실패 시 기존 refresh 유지 |
| 로깅 | 실패 사유(code, http_status) action_log "AUTH_REFRESH_FAIL" | 관측/경보 기준 |
| 보안 | 5분 내 5회 실패 시 계정 보호(추가 차단 T.B.D.) | SHOULD 단계 |

Pseudo Flow:
1) API 호출 전 access 만료 임박(exp-30s 이내) → 선행 refresh.
2) 호출 401(token_expired) → refresh(즉시) → 성공 시 원 요청 1회 재시도.
3) refresh 1차 실패 → 3초 후 2차 재시도.
4) 2차 실패 → logout() + `feedback: { code: 'auth.session.expired', severity:'warn' }` enqueue.
5) 사용자가 재로그인 성공 시 이전 경로 복귀(선택 구현).

서버 TODO:
- `/api/auth/refresh` 실패 케이스 명시 enum: token_expired, token_invalid, token_revoked.
- 실패 사유마다 401/400 구분 (expired=401, invalid/revoked=400) 문서화.

#### (신규) Gacha net_change 계산 규칙
- 정의: 요청 전 잔액(old_balance) 대비 응답 시 잔액(new_balance)의 차이 (new_balance - old_balance)
- 특징: 현재 가챠는 즉시 토큰 차감 후 추가 토큰 보상 없음 → 예상 net_change는 음수(= -cost). 향후 가챠 내 토큰/코인 보상 추가 시 그대로 증가분 반영.
- 실패/예외: old_balance 확보 실패 시 null 반환(클라이언트 보정 불필요).
- Slot 계산과의 정합성: Slot은 (win_amount - bet_amount) 로직 → 둘 다 '세션 단위 순변동' 표준화.


------------------------
긴급(백엔드 안정화)
1.1 APScheduler job 안전화(예외 무시 또는 실행 전 컬럼 존재 체크) — 목표: 로그 폭주/5xx 차단. (todo #12)
1.2 누락 컬럼 추가 마이그레이션 생성(또는 수동 ALTER TABLE) — 목표: job 원인 제거. (todo #6)
긴급(프론트엔드 허들 제거)
2.1 브라우저 localStorage 클리어 안내(개발자에게) — 토큰 관련 403 원인 순환 점검. (todo #8)
2.2 /api/notification/settings 엔드포인트 일시 스텁 제공(백엔드) — 404 제거. (todo #11)
2.3 apiClient 방어 코드: 404/403 처리 및 무한 루프 차단. (todo #9)
2.4 NEXT dev proxy/API_BASE_URL 확인(토큰/도메인 불일치 방지). (todo #10)
중기(배포 안전)
CI에 alembic 체크/스테이징 배포 절차 추가. (todo #5)
보안/운영
dev-fallback 비활성화, 디버그 엔드포인트 차단, 시크릿 매니저 전환. (todo #2, #3, #1 완료)

