# 인증 시스템 테스트 가이드

## 목적
이 문서는 개선된 인증 시스템의 기능을 검증하기 위한 종합적인 테스트 방법을 제공합니다. 개선된 인증 시스템에는 다음과 같은 주요 기능이 포함되어 있습니다:

1. 회원가입 및 로그인
2. JWT 액세스 토큰 및 리프레시 토큰 관리
3. 토큰 자동 갱신
4. 세션 관리
5. 로그아웃 및 토큰 무효화
6. 오류 처리 및 보안 기능

## 테스트 사전 요구사항

### 백엔드 서버
1. FastAPI 서버가 실행 중이어야 합니다.
2. Redis 서버가 실행 중이어야 합니다 (토큰 블랙리스트 용).
3. PostgreSQL 데이터베이스가 실행 중이어야 합니다.

### 프론트엔드
1. 회원가입 및 로그인 UI가 구현되어 있어야 합니다.
2. 토큰 관리 로직이 구현되어 있어야 합니다.
3. 인증이 필요한 보호된 라우트가 있어야 합니다.

## 테스트 도구
1. **백엔드 API 테스트**: `tests/test_auth_api.py` (Python 스크립트)
2. **통합 테스트**: `tests/test_auth_integration.py` (Python pytest)
3. **UI 테스트 시나리오**: `tests/auth_ui_test_scenarios.py` (체크리스트)

## 테스트 실행 방법

### 백엔드 API 테스트
```bash
cd backend
python tests/test_auth_api.py
```

이 테스트는 다음과 같은 항목을 검증합니다:
- 회원가입 기능
- 로그인 기능
- 토큰 갱신 기능
- 사용자 프로필 조회
- 세션 목록 조회
- 로그아웃 및 토큰 무효화

### 통합 테스트 (Pytest)
```bash
cd backend
pytest tests/test_auth_integration.py -v
```

이 테스트는 다음과 같은 항목을 검증합니다:
- 전체 인증 흐름 (회원가입부터 로그아웃까지)
- 토큰 만료 처리
- 사용된 리프레시 토큰 재사용 방지

### UI 테스트 체크리스트
UI 테스트는 수동으로 진행해야 합니다. `tests/auth_ui_test_scenarios.py` 파일에 정의된 시나리오를 따라 테스트를 진행하세요.

```bash
cd backend
python tests/auth_ui_test_scenarios.py
```

위 명령을 실행하면 UI 테스트를 위한 모든 시나리오가 출력됩니다.

## 주요 테스트 케이스

### 1. 회원가입 및 로그인
- 유효한 초대코드로 회원가입
- 이미 사용된 초대코드로 회원가입 (실패 예상)
- 중복된 닉네임으로 회원가입 (실패 예상)
- 유효한 site_id로 로그인
- 존재하지 않는 site_id로 로그인 (실패 예상)
- 과도한 로그인 시도 제한 확인

### 2. 토큰 관리
- 액세스 토큰과 리프레시 토큰 발급 확인
- 액세스 토큰으로 보호된 리소스 접근
- 리프레시 토큰으로 새 액세스 토큰 발급
- 리프레시 토큰 회전 (새 리프레시 토큰 발급) 확인
- 만료된 액세스 토큰 사용 시 오류 확인
- 블랙리스트된 토큰 사용 시 오류 확인

### 3. 세션 관리
- 로그인 후 세션 생성 확인
- 여러 기기에서 동일 계정 로그인 시 다중 세션 생성 확인
- 특정 세션 종료 기능
- 모든 세션 종료 기능

### 4. 로그아웃 및 토큰 무효화
- 로그아웃 시 토큰 블랙리스트 추가 확인
- 로그아웃 후 보호된 리소스 접근 불가 확인
- 모든 기기에서 로그아웃 기능

### 5. 보안 기능
- 토큰 변조 시도에 대한 보호
- CSRF 방지 메커니즘
- 리프레시 토큰 재사용 방지

## 문제 해결 가이드

### 토큰 관련 문제
- **토큰 검증 실패**: JWT_SECRET_KEY와 JWT_ALGORITHM 설정을 확인하세요.
- **토큰 만료 오류**: 토큰 만료 시간 설정을 확인하세요.
- **리프레시 토큰 오류**: 데이터베이스의 리프레시 토큰 레코드를 확인하세요.

### Redis 관련 문제
- **토큰 블랙리스트 오류**: Redis 서버 연결을 확인하세요. 메모리 기반 fallback이 작동하는지 확인하세요.

### 데이터베이스 관련 문제
- **세션 관리 오류**: 데이터베이스의 UserSession 테이블을 확인하세요.
- **사용자 정보 조회 오류**: 데이터베이스의 User 테이블을 확인하세요.

## 테스트 결과 기록

테스트 실행 후, 다음 사항을 기록하세요:
1. 테스트 날짜 및 시간
2. 테스트 환경 (OS, 브라우저 등)
3. 성공한 테스트 케이스
4. 실패한 테스트 케이스와 오류 메시지
5. 발견된 버그 및 개선 사항
