# 🎮 Casino-Club F2P 게임 API 구현 가이드

## 📊 게임별 설정 및 승률

### 1. 🎰 슬롯 머신 (Slot Machine)

#### 기본 설정
- **엔드포인트**: `POST /api/actions/SLOT_SPIN`
- **베팅 금액**: 5,000~10,000코인
- **승리 확률**: 15% (기본)
- **수익률**: 사이트가 85% 가져감
- **일일 횟수 제한**: 30회 (고정)
- **VIP 특전**: 동일 횟수, 높은 당첨률

#### 구현 요구사항
```json
// 요청 예시
{
  "user_id": "12345",
  "bet_amount": 5000,
  "lines": 3,
  "vip_mode": false
}

// 응답 예시
{
  "spin_id": "spin_293847",
  "result": [
    [1, 4, 2],
    [3, 3, 3],
    [2, 1, 5]
  ],
  "win_lines": [2],
  "win_amount": 15000,
  "multiplier": 3,
  "remaining_spins": 29,
  "streak_count": 1,
  "special_event": null
}
```

#### 알고리즘 가이드
1. **확률 테이블** - 심볼별 출현 가중치
   ```
   7️⃣ (잭팟): 0.1%
   🍒 (체리): 15%
   🍋 (레몬): 20%
   🔔 (벨): 15%
   💎 (다이아몬드): 5%
   🍇 (포도): 20%
   🍊 (오렌지): 24.9%
   ```

2. **승리 조합**
   ```
   3x 7️⃣: 100배 (잭팟)
   3x 💎: 50배
   3x 🔔: 25배
   3x 🍒: 15배
   3x 🍋/🍇/🍊: 5배
   ```

3. **스트릭 시스템**
   - 연속 3번 실패: 다음 회 승률 +5%
   - 연속 5번 실패: 다음 회 승률 +10%
   - 연속 10번 실패: 다음 회 승률 +25%

### 2. 📈 네온 크래시 (Crash Game)

#### 기본 설정
- **엔드포인트**: `POST /api/games/crash`
- **베팅 금액**: 5,000~10,000코인
- **승리 조건**: 유저가 충돌 전에 캐시아웃 성공
- **수익률**: 사이트가 평균 15% 가져감
- **일일 횟수 제한**: 15회 (고정)
- **VIP 특전**: 손실 보장 1회 (재도전 기회)

#### 구현 요구사항
```json
// 요청 예시 (게임 시작)
{
  "user_id": "12345",
  "bet_amount": 5000,
  "auto_cashout_multiplier": 2.0
}

// 응답 예시 (게임 시작)
{
  "game_id": "crash_485739",
  "start_time": "2025-08-05T15:30:00Z",
  "remaining_games": 14
}

// 요청 예시 (캐시아웃)
{
  "game_id": "crash_485739",
  "user_id": "12345",
  "cashout_time": "2025-08-05T15:30:05Z"
}

// 응답 예시 (결과)
{
  "game_id": "crash_485739",
  "crashed_at": 2.5,
  "cashout_multiplier": 1.8,
  "win_amount": 9000,
  "is_success": true,
  "remaining_games": 14
}
```

#### 알고리즘 가이드
1. **충돌 곡선 생성**
   - 지민함수 기반 (y = e^(x/randomFactor))
   - 최소 충돌값: 1.0
   - 최대 충돌값: 10.0
   - 평균 충돌값: ~1.9 (수학적으로 설계)

2. **크래시 확률 분포**
   ```
   1.0x~1.2x: 30%
   1.2x~1.5x: 25%
   1.5x~2.0x: 20%
   2.0x~3.0x: 15%
   3.0x~5.0x: 8%
   5.0x~10.0x: 2%
   ```

3. **특별 이벤트**
   - 30게임마다 가능한 최대 충돌값 상향 (최대 20.0x)
   - VIP 유저는 10게임마다 1회 재도전 기회

### 3. ✂️ 가위바위보 (Rock-Paper-Scissors)

#### 기본 설정
- **엔드포인트**: `POST /api/games/rps`
- **베팅 금액**: 5,000~10,000코인
- **승리 확률**: 정상 33% (조정 후 30%)
- **수익률**: 사이트가 12% 가져감
- **일일 횟수 제한**: 일반 3회 / VIP 5회
- **VIP 특전**: 추가 게임 횟수, Hint 시스템

#### 구현 요구사항
```json
// 요청 예시
{
  "user_id": "12345",
  "bet_amount": 5000,
  "user_choice": "rock",
  "use_hint": false
}

// 응답 예시
{
  "game_id": "rps_934857",
  "user_choice": "rock",
  "computer_choice": "scissors",
  "result": "win",
  "win_amount": 10000,
  "remaining_games": 2,
  "hint_available": true
}
```

#### 알고리즘 가이드
1. **승패 결정**
   - 기본 확률: 이길 확률 30%, 비길 확률 10%, 질 확률 60%
   - 연속 패배 보정: 2연패 후 이길 확률 +10%
   - VIP 보정: 기본 이길 확률 +5%

2. **힌트 시스템 (VIP 전용)**
   - VIP 유저는 게임당 1회 힌트 사용 가능
   - 힌트 사용 시 컴퓨터의 선택이 30% 확률로 노출

### 4. 🎁 가챠 시스템 (Gacha)

#### 기본 설정
- **엔드포인트**: `POST /api/games/gacha/pull`
- **비용**: 50,000코인 (고정)
- **수익률**: 사이트가 100% 가져감 (아이템은 가상재화)
- **일일 횟수 제한**: 일반 3회 / VIP 5회
- **VIP 특전**: 추가 게임 횟수, 천장 보장 시스템

#### 구현 요구사항
```json
// 요청 예시
{
  "user_id": "12345",
  "gacha_type": "standard",
  "pull_count": 1
}

// 응답 예시
{
  "pull_id": "gacha_384957",
  "items": [
    {
      "item_id": "item_58473",
      "name": "레이스 란제리",
      "rarity": "rare",
      "type": "skin",
      "value": 1000,
      "icon": "🖤",
      "description": "고급스러운 블랙 레이스 란제리 세트"
    }
  ],
  "is_new_item": true,
  "remaining_pulls": 2,
  "pity_counter": 8
}
```

#### 알고리즘 가이드
1. **아이템 등급별 확률**
   ```
   일반(common): 60%
   레어(rare): 25%
   에픽(epic): 10%
   레전더리(legendary): 4.5%
   미식(mythic): 0.5%
   ```

2. **천장/보장 시스템**
   - 50회 연속 레전더리 미획득 시 다음 회 100% 등장
   - 10회 연속 에픽 미획득 시 다음 회 100% 등장
   - VIP 유저: 30회 레전더리 보장, 5회 에픽 보장

## 🔄 공통 API 요소

### 1. 게임 제한 시스템
```json
// GET /api/user/game-limits
{
  "user_id": "12345",
  "daily_limits": {
    "slot": {"max": 30, "remaining": 25},
    "crash": {"max": 15, "remaining": 12},
    "rps": {"max": 3, "remaining": 2},
    "gacha": {"max": 3, "remaining": 3}
  },
  "vip_status": false,
  "reset_time": "2025-08-06T00:00:00Z"
}
```

### 2. 보상 지급 시스템
```json
// POST /api/rewards
{
  "user_id": "12345",
  "game_id": "slot_293847",
  "reward_amount": 15000,
  "reward_type": "coin",
  "transaction_id": "txn_384756",
  "reason": "slot_win"
}

// 응답
{
  "reward_id": "rwd_495867",
  "status": "success",
  "new_balance": 145000,
  "transaction_id": "txn_384756"
}
```

### 3. 사용자 행동 로깅 시스템
```json
// POST /api/actions
{
  "user_id": "12345",
  "action_type": "SLOT_SPIN",
  "context": {
    "bet_amount": 5000,
    "result": "win",
    "win_amount": 15000,
    "game_id": "slot_293847"
  },
  "device_info": {
    "platform": "web",
    "os": "Windows",
    "browser": "Chrome"
  },
  "timestamp": "2025-08-05T15:30:00Z"
}
```

## 📋 API 구현 체크리스트

### 🎰 슬롯 머신 API
- [x] 기본 스핀 엔드포인트 구현 
- [x] 베팅 금액 범위 유효성 검사 (5,000~10,000)
- [x] 일일 횟수 제한 시스템 구현 (30회)
- [x] 확률 테이블 및 심볼별 가중치 구현
- [x] 승리 조합 및 배수 계산 로직 구현
- [x] 스트릭 시스템 구현
- [x] 보상 지급 연동
- [x] 게임 결과 로깅
- [ ] VIP 사용자 혜택 추가

### 📈 네온 크래시 API
- [ ] 게임 시작 및 캐시아웃 엔드포인트 구현
- [ ] 지민함수 기반 충돌 곡선 생성
- [ ] 확률 분포 구현 (수학적 검증 필요)
- [ ] 실시간 멀티플레이어 지원
- [ ] 자동 캐시아웃 기능
- [ ] 특별 이벤트 로직
- [ ] VIP 재도전 시스템 구현
- [ ] 게임 히스토리 및 통계 추적

### ✂️ 가위바위보 API
- [ ] 기본 게임 로직 구현
- [ ] 조정된 승패 확률 적용 (30% 승리)
- [ ] 연속 패배 보정 시스템
- [ ] 일일 게임 횟수 제한 (일반 3회 / VIP 5회)
- [ ] VIP 힌트 시스템 구현
- [ ] 베팅 금액 범위 유효성 검사
- [ ] 보상 계산 및 지급
- [ ] 게임 결과 로깅

### 🎁 가챠 시스템 API
- [ ] 단일 및 10연속 뽑기 엔드포인트
- [ ] 아이템 등급별 확률 구현
- [ ] 천장/보장 시스템 구현
- [ ] 일일 횟수 제한 (일반 3회 / VIP 5회)
- [ ] 아이템 인벤토리 연동
- [ ] 중복 아이템 처리 로직
- [ ] VIP 혜택 시스템 (천장 단축)
- [ ] 가챠 결과 로깅

### 🔄 공통 시스템
- [x] 사용자 게임 제한 시스템 구현
- [x] 보상 지급 트랜잭션 시스템
- [x] 사용자 행동 로깅 시스템
- [ ] VIP 상태 감지 및 혜택 적용
- [x] 일일 리셋 시스템 (자정 기준)
- [ ] 통계 및 분석 데이터 수집
- [x] 오류 처리 및 보상 복구 메커니즘
- [ ] API 성능 최적화 및 부하 테스트

## 🔍 테스트 시나리오

### 1. 승률 검증
- [x] 각 게임 1,000회 이상 시뮬레이션 실행 (슬롯 게임만)
- [x] 목표 승률(슬롯 15%)과의 편차 ±3% 이내 
- [ ] VIP 혜택이 정확히 적용되는지 확인
- [x] 연속 패배 보정 시스템 적용 검증 (슬롯 게임만)

### 2. 제한 시스템 테스트
- [ ] 일일 한도 초과 시 적절한 오류 응답
- [ ] 자정에 제한이 정확히 리셋되는지 확인
- [ ] VIP/일반 사용자의 제한이 올바르게 구분

### 3. 경계 조건 테스트
- [ ] 최대/최소 베팅 금액 경계값 테스트
- [ ] 잔액 부족 시나리오
- [ ] 대규모 당첨 처리
- [ ] 네트워크 지연 및 중단 시나리오

## 🚀 구현 우선순위

1. **기본 게임 로직 및 API 구조** (1주)
   - 모든 게임의 기본 엔드포인트 및 응답 구조
   - 데이터베이스 스키마 및 모델

2. **게임별 핵심 메커니즘** (2주)
   - 슬롯 머신 확률 및 결과 생성
   - 가위바위보 승패 로직
   - 크래시 게임 곡선 생성
   - 가챠 아이템 및 확률

3. **제한 및 보상 시스템** (1주)
   - 일일 횟수 제한
   - 보상 지급 트랜잭션
   - 사용자 잔액 관리

4. **VIP 혜택 및 특수 기능** (1주)
   - 천장/보장 시스템
   - 힌트 시스템
   - 특별 이벤트

5. **로깅 및 분석** (1주)
   - 사용자 행동 로깅
   - 통계 수집
   - 성능 모니터링

6. **테스트 및 최적화** (1주)
   - 대량 시뮬레이션
   - 부하 테스트
   - 최종 미세 조정

## 📋 현재 구현 상태 및 체크리스트

### ✅ 이미 구현된 기능

#### 인증 관련
- ✅ 초대코드 유효성 검증 API (`GET /auth/check-invite/{code}`)
- ✅ 회원가입 API (`POST /auth/register`)
- ✅ 로그인 API (`POST /auth/login`)
- ✅ 사용자 정보 조회 API (`GET /auth/me`)
- ✅ JWT 인증 및 권한 관리 기본 구현
- ✅ 로그아웃 API (`POST /auth/logout`)

#### 인프라 구축
- ✅ FastAPI 프로젝트 초기화 및 구조화
- ✅ PostgreSQL 연동 및 SQLAlchemy ORM 설정
- ✅ Alembic 마이그레이션 구성
- ✅ Kafka 연동 및 설정

#### 프로필 관련
- ✅ 프로필 조회 API (`GET /api/users/{id}/profile`)

### ⚠️ 부분적으로 구현된 기능

#### 인증 기능
- ⚠️ 토큰 갱신 API (`POST /auth/refresh`) - 기본 구현은 되어있으나 완벽하지 않음
- ⚠️ 모든 세션 로그아웃 API (`POST /auth/logout-all`) - 구조만 있고 완전히 구현되지 않음

### ❌ 아직 구현되지 않은 기능

#### 게임 관련 API

##### 슬롯 게임 API (`POST /api/actions/SLOT_SPIN`)
- ✅ 슬롯 스핀 확률 테이블 구현
- ✅ 스트릭/연속 보상 메커니즘 구현
- ✅ 결과 결정 알고리즘 구현
- ✅ 랜덤 생성기 구현
- ✅ 보상 지급 연동 구현
- ✅ 사용자 액션 로깅 구현

##### 네온 크래시 게임 API (`POST /api/games/crash`)
- ❌ 지민함수 기반 충돌 곡선 생성
- ❌ 실시간 멀티플레이어 지원
- ❌ 자동 캐시아웃 기능
- ❌ VIP 재도전 시스템

##### 가위바위보 API (`POST /api/games/rps`)
- ❌ 기본 게임 로직 구현
- ❌ 조정된 승패 확률 적용
- ❌ VIP 힌트 시스템 구현

##### 가챠 스핀 API (`POST /api/games/gacha/pull`)
- ❌ 등급별 아이템 확률 테이블 구현
- ❌ 천장/보장 메커니즘 구현
- ❌ 가챠 비용 차감 로직 구현
- ❌ 아이템 지급 로직 구현
- ❌ 확률 공개 정보 구현
- ❌ 가챠 결과 히스토리 구현

#### 보상 관련
- ✅ 보상 지급 API (`POST /api/rewards`)
  - ✅ 보상 유형별 처리 (코인, 젬, 아이템)
  - ✅ 트랜잭션 처리 (원자성)
  - ✅ 중복 지급 방지 (idempotency)
  - ✅ 보상 히스토리 기록
  - ❌ 특별 보상 처리 (이벤트, 프로모션)
  - ❌ 알림 연동 (보상 지급 알림)

#### 실시간 기능
- ❌ 실시간 알림 API (SSE/WebSocket)
  - ❌ 연결 관리 및 세션 유지
  - ❌ 메시지 큐 및 버퍼링
  - ❌ 사용자별 알림 필터링
  - ❌ 연결 끊김 감지 및 재연결
  - ❌ 멀티플렉싱 지원
  - ❌ 알림 우선순위 및 배치 처리

#### 로깅/분석
- ✅ 사용자 행동 로깅 API (`POST /api/actions`)
  - ✅ 액션 타입 분류 체계
  - ✅ 로그 데이터 구조 설계
  - ⚠️ 대용량 로그 처리 최적화 (기본 구현됨)
  - ❌ 실시간 행동 분석 파이프라인
  - ✅ 개인정보 보호 필터링
  - ❌ 로그 압축 및 아카이빙

#### 수익화 관련
- ❌ 상점/프리미엄 잼 구매 API (`POST /api/shop/buy`)
  - ❌ 상품 카탈로그 관리
  - ❌ 가격 정책 및 할인 시스템
  - ❌ 구매 전 검증 (잔액, 자격 등)
  - ❌ 결제 게이트웨이 연동
  - ❌ 구매 완료 후 보상 지급
  - ❌ 영수증 발행 및 기록

- ❌ 한정 패키지 API
  - ❌ 시간 제한 패키지 스케줄링
  - ❌ 긴급 패키지 비활성화 기능

#### 관리자 기능
- ❌ 회원 관리 API (목록, 상세, 등급/상태 변경, 삭제, 로그)
- ❌ 보상/아이템 관리 API
- ❌ 알림/캠페인 관리 API

## 🔄 구현 우선순위 제안

### 1단계 (핵심 기능)
- **토큰 갱신 API 완성** (`POST /auth/refresh`)
- **게임 API** (슬롯, 가챠) - 기본 게임 플레이를 위한 핵심 기능
- **보상 지급 API** - 게임과 밀접하게 연결된 보상 시스템

### 2단계 (사용자 유지 기능)
- **사용자 행동 로깅 API** - 사용자 행동 추적 및 분석
- **실시간 알림 API** - 사용자 참여 증가

### 3단계 (수익화 기능)
- **상점/프리미엄 잼 구매 API** - 수익화 모델
- **한정 패키지 API** - 추가 수익화 요소

### 4단계 (관리 기능)
- **관리자 기능 API** - 시스템 관리 및 모니터링

## 📱 프론트엔드 개발 가이드

### 🚨 프론트엔드 개발 주의사항

1. **프로젝트 구조 변경 금지**
   - 기존 폴더 구조 및 파일 경로를 임의로 변경하지 말 것
   - 새로운 디렉토리 구조를 도입하기 전 반드시 협의할 것
   - 특히 `/src` 폴더 구조 변경은 엄격히 제한됨

2. **UI 디자인 시스템 준수**
   - 프로젝트의 기존 디자인 시스템 및 컴포넌트를 사용할 것
   - 외부 UI 라이브러리(Material UI, Ant Design 등) 추가 시 사전 승인 필요
   - 임의로 스타일 시스템을 바꾸지 말 것 (Tailwind에서 다른 시스템으로 전환 등)

3. **API 클라이언트 구조**
   - API 클라이언트 파일 위치: `/frontend/src/api/[기능명].ts`
   - 예: 슬롯 머신 API 클라이언트는 `/frontend/src/api/slotMachine.ts`에 위치
   - API 클라이언트는 인터페이스 정의와 함수만 포함하고 디자인 로직 포함 금지

4. **컴포넌트 분리 원칙**
   - 비즈니스 로직과 UI 컴포넌트 분리
   - 컴포넌트는 `/frontend/components` 경로에 위치
   - 페이지는 `/frontend/pages` 경로에 위치

### 📂 슬롯 머신 구현 파일 구조

```
/frontend/
  /src/
    /api/
      slotMachine.ts  # API 클라이언트 (인터페이스 및 API 호출 함수) - ✅ 구현 완료
    /hooks/
      useSlotMachine.ts  # 슬롯 머신 관련 커스텀 훅
  /components/
    /games/
      /slot/
        SlotMachine.tsx  # 슬롯 머신 게임 컴포넌트
        SlotControls.tsx  # 베팅 컨트롤 UI
        SlotResults.tsx   # 결과 표시 UI
  /pages/
    /games/
      slot.tsx  # 슬롯 머신 페이지
```

### 🚀 프론트엔드 구현 상태

- ✅ 슬롯 머신 API 클라이언트 (`/frontend/src/api/slotMachine.ts`)
- ❌ 슬롯 머신 UI 컴포넌트
- ❌ 슬롯 머신 페이지

### 🔄 API 통합 워크플로우

1. 백엔드 API 명세 확인 (본 문서)
2. API 인터페이스 정의 (`/frontend/src/api/[기능명].ts`)
3. API 클라이언트 함수 구현
4. 커스텀 훅으로 비즈니스 로직 분리
5. UI 컴포넌트 구현
6. 페이지에 통합

이 지침을 따르면 프론트엔드와 백엔드 개발이 원활하게 통합되고 디자인 침해 문제가 방지됩니다.
