groups:
  - name: legacy-ws-usage
    interval: 30s
    rules:
      - alert: LegacyWsUsagePersisting
        expr: sum(rate(ws_legacy_games_connections_total[5m])) > 0
        for: 15m
        labels:
          severity: warning
          team: realtime
        annotations:
          summary: "레거시 WS 사용률이 15분 이상 0 초과"
          description: |
            레거시 /api/games/ws 경로가 지속 사용 중입니다. 프론트/봇/스크립트 중 남은 호출을 표준 /api/realtime/sync 로 전환하세요.
            사용량 0으로 수렴 시 ENABLE_LEGACY_GAMES_WS=0 고정 및 라우터 제거 PR을 진행합니다.

      - alert: ShopLatencyP95High
        expr: histogram_quantile(0.95, sum(rate(http_requests_duration_seconds_bucket{job="cc-webapp-backend",handler=~".*shop.*"}[5m])) by (le)) > 0.8
        for: 10m
        labels:
          severity: warning
          team: shop
        annotations:
          summary: "상점 P95 지연 800ms 초과"
          description: "최근 10분 동안 상점 관련 엔드포인트의 P95 지연이 800ms를 초과했습니다. 결제사/DB/캐시 상태 확인 필요."

      - alert: ShopErrorRateHigh
        expr: sum(rate(http_requests_total{job="cc-webapp-backend",handler=~".*shop.*",status=~"5.."}[5m])) / clamp_min(sum(rate(http_requests_total{job="cc-webapp-backend",handler=~".*shop.*"}[5m])), 1e-9) > 0.02
        for: 10m
        labels:
          severity: critical
          team: shop
        annotations:
          summary: "상점 5xx 오류율 2% 초과"
          description: "최근 10분 상점 5xx 비율이 2%를 초과했습니다. 장애 조사 필요."
