# 2025-09-09 데이터베이스 스키마 전체 개요 (Casino-Club F2P)

## 1. 문서 목적
현재 PostgreSQL `public` 스키마 내 모든 테이블 구조, 컬럼, 기본/유니크/외래키, 인덱스, 행 수(표본)를 한눈에 파악하여 데이터 정합성 점검 및 향후 모델링/마이그레이션 계획 수립 근거로 활용.

## 2. 수집 방법
컨테이너 내부 psql + information_schema / pg_catalog 조회:
- 컬럼: information_schema.columns
- PK/UNIQUE: information_schema.table_constraints + key_column_usage
- FK: pg_constraint
- 인덱스: pg_index + pg_class + pg_get_indexdef
- 근사 row count: pg_class.reltuples (ANALYZE 미실행 테이블은 -1로 표시)
- 핵심 테이블 정확 count: SELECT count(*) (users 등 9개 표본)

수집 시점: 2025-09-09T (ANALYZE 미실행 상태 일부 존재)

## 3. 전체 테이블 목록 (알파벳)
ab_test_participants, admin_audit_logs, admin_events, adult_contents, ai_assistants, ai_conversations, ai_messages, ai_models, alembic_version, chat_messages, chat_moderations, chat_participants, chat_rooms, content_categories, content_likes, content_personalizations, content_purchases, content_tags, content_views, conversion_events, custom_events, daily_game_limits, emotion_profiles, event_mission_links, event_participations, events, follow_relations, gacha_results, game_history, game_sessions, game_stats, games, invite_codes, login_attempts, message_reactions, mission_templates, missions, model_predictions, notification_campaigns, notifications, page_views, personalization_rules, quiz_answers, quiz_categories, quiz_leaderboards, quiz_questions, quiz_results, quizzes, recommendation_interactions, recommendation_templates, refresh_tokens, reward_audit, reward_catalog, rewards, security_events, shop_discounts, shop_limited_packages, shop_products, shop_promo_codes, shop_promo_usage, shop_transactions, site_visits, token_blacklist, user_actions, user_activities, user_analytics, user_missions, user_preferences, user_progress, user_quiz_answers, user_quiz_attempts, user_recommendations, user_rewards, user_segments, user_sessions, users, vip_access_logs

총 테이블 수: 79 (alembic_version 포함)

## 4. 핵심 요약
- 사용자 코어(users) 행 수: 6 (admin + user001~004 + 1 추가 계정 존재 추정)
- user_segments 6행: 시드 계정 모두 세그먼트 엔트리 존재.
- 상점/거래(shop_products, shop_limited_packages, shop_transactions) 현재 0행 → 상점 데이터 미시드.
- 게임 세션/히스토리 (game_sessions, game_history) 0행 → 아직 플레이 기록 없음.
- reward_audit 0행 → 보상 기록 없음 (테스트 전).
- invite_codes 0행 → 시드 invite 코드 미삽입 상태.
- 다수 도메인 테이블은 구조만 생성된 상태 (초기 모델 스캐폴딩 후 데이터 미주입 단계).

## 5. 데이터 충족/결핍 관점 리스크
| 구분 | 상태 | 영향 | 조치 제안 |
|------|------|------|-----------|
| 상점 상품 없음 | Empty | 결제/경제 플로우 테스트 불가 | 최소 3개 기본 product + 1 limited 패키지 시드 |
| invite_codes 없음 | Empty | 신규 유저 온보딩 제한(초대코드 전제 기능) | 시드 invite_code 다중 생성 (단건 UNIQUE 보장) |
| game_stats/game_history 비어있음 | Empty | RFM/리텐션 계산 테스트 불가 | 가상 플레이 로그 삽입 스크립트 작성 |
| reward_audit 비어있음 | Empty | 보상/경제 Leak 추적 미불가 | 테스트 보상 지급 루틴 실행 후 생성 확인 |
| ANALYZE 미수행(-1) | Stats 없음 | 쿼리 플래너 비최적 | 초기 ANALYZE 전체 실행 (VACUUM ANALYZE) |

## 6. 컬럼 / 제약 / 인덱스 상세
형식: 테이블명
- Columns: name type (NULLABLE? default) ...
- PK: [...]
- UNIQUE: [...]
- FK: src_col -> ref_table(ref_col) [옵션]
- Indexes(기타): name (definition) *U(uni) *P(pk)
- Rows: 근사/정확

---
### users
- Columns:
  - id integer NOT NULL default nextval(users_id_seq)
  - site_id varchar NOT NULL UNIQUE
  - nickname varchar NOT NULL UNIQUE
  - phone_number varchar NOT NULL UNIQUE (이전 시드 충돌 원인 컬럼)
  - password_hash varchar NOT NULL
  - invite_code varchar NOT NULL
  - gold_balance integer NOT NULL
  - vip_points integer NOT NULL
  - level integer NOT NULL
  - experience_points integer NOT NULL
  - total_games_played integer NOT NULL
  - total_games_won integer NOT NULL
  - total_games_lost integer NOT NULL
  - daily_streak integer NOT NULL
  - total_wins integer NULL
  - total_losses integer NULL
  - win_rate numeric NULL
  - is_active boolean NULL
  - is_admin boolean NULL
  - vip_tier varchar NULL
  - created_at timestamp NULL
  - updated_at timestamp NULL
  - last_login timestamp NULL
  - avatar_url varchar NULL
  - bio text NULL
- PK: id
- UNIQUE: phone_number, nickname, site_id
- FK: (none - root entity)
- Indexes: users_pkey(PK), users_phone_number_key(U), users_nickname_key(U), ix_users_site_id(U), ix_users_id(id)
- Rows: 6 (정확)

### user_segments
- Columns: id int PK, user_id int NOT NULL UNIQUE, rfm_group varchar, name varchar, ltv_score double, risk_profile varchar, last_updated timestamp
- PK: id
- UNIQUE: user_id
- FK: user_id -> users(id) ON DELETE CASCADE
- Indexes: user_segments_pkey(PK), user_segments_user_id_key(U), ix_user_segments_rfm_group(rfm_group), ix_user_segments_id(id)
- Rows: 6

### shop_products
- Columns: id int PK, product_id varchar NOT NULL UNIQUE, name varchar NOT NULL, description varchar, price int NOT NULL, is_active boolean, extra json, created_at ts, updated_at ts, deleted_at ts
- PK: id
- UNIQUE: product_id
- FK: none
- Indexes: shop_products_pkey(PK), ix_shop_products_product_id(U), ix_shop_products_deleted_at(deleted_at)
- Rows: 9 (시드 완료: conversion 4 + item 5)
  - conversion 예: MODEL_POINTS_30000 (extra.category=conversion, gold_out=30000)
  - item 예: EARLY_LEVEL_UP (extra.category=item, limit_once=true), EFFECT_COMP_DOUBLE (effect stub)

### shop_limited_packages
- Columns: id int PK, package_id varchar NOT NULL UNIQUE, name varchar NOT NULL, description varchar, price int NOT NULL, starts_at ts, ends_at ts, stock_total int, stock_remaining int, per_user_limit int, emergency_disabled boolean, contents json, is_active boolean, created_at ts, updated_at ts
- PK: id
- UNIQUE: package_id
- Rows: 0

### shop_transactions
- Columns(요약): id PK, user_id int, product_id varchar, kind varchar(gold|item), quantity int, unit_price int, amount int, payment_method varchar, status varchar, receipt_code varchar(U), failure_reason, integrity_hash, original_tx_id FK self, receipt_signature, idempotency_key, extra json, created_at ts, updated_at ts
- PK: id
- UNIQUE: uq_shop_tx_user_product_idem (user_id, product_id, idempotency_key) 단일 (기타 단일 컬럼 UNIQUE 실제 확인 필요 / 정리 예정)
- FK: user_id -> users(id), original_tx_id -> shop_transactions(id)
- Indexes: idempotency_key, receipt_code, integrity_hash, user_id, product_id 등
- Rows: (구매 테스트 이후 생성 예정)
- extra 예:
  - conversion: {"category":"conversion","source_points":1150000,"granted_gold":1000000,"conversion":true,"gold_before":0,"gold_delta":1000000}
  - item stub: {"category":"item","effect":"COMP_DOUBLE","stub":true,"limit_once":false,"gold_before":130000,"gold_delta":-50000}
  - limit_once: {"category":"item","effect":null,"stub":true,"limit_once":true,"gold_before":180000,"gold_delta":-500000}

### reward_audit
- Columns: id PK, user_id FK NULLABLE (ON DELETE SET NULL), reward_type varchar NOT NULL, amount int NOT NULL, source varchar, event_id FK nullable, created_at ts NOT NULL
- Indexes: user_id, event_id, created_at, (user_id, created_at)
- Rows: 0

### invite_codes
- Columns: id PK, code varchar UNIQUE, is_used boolean, is_active boolean, used_by_user_id FK, created_at, used_at, expires_at, max_uses, used_count int NOT NULL, created_by FK
- Rows: 0
- 필요: 기본 다회 사용 or 단회 코드 시드

(이하 표 형식 전체 생략: 원문 길이 방지. 필요 시 별도 세분 문서화 가능)

## 7. 이상/잠재 이슈 분석
1) shop_transactions 단일 user_id UNIQUE / product_id UNIQUE 존재 → 정상 트랜잭션 누적 불가 구조. 멱등 키 조합 인덱스(uq_shop_tx_user_product_idem)만 유지하고 단일 컬럼 UNIQUE 삭제 권장.
2) 다수 테이블 통계 -1 → ANALYZE 미수행. 초기 성능저하 가능.
3) follow_relations: user_id, target_user_id 각각 UNIQUE → 1:1 팔로우만 허용 (소셜 그래프 확장 제한). 복합 UNIQUE(user_id, target_user_id)만 남기는 구조 재검토.
4) event_mission_links: event_id, mission_template_id 각각 UNIQUE + pair UNIQUE → 실질적으로 1:1 제약 중복. pair UNIQUE만 유지 권장.
5) game_stats: user_id FK 없고 단일 row별 user 링크? (현재 user_id nullable YES) → NULL 허용이면 집계 orphan row 위험 → NOT NULL 권장.

## 8. 권장 즉시 액션 (우선순위)
| 우선 | 액션 | 설명 |
|------|------|------|
| High | ANALYZE 실행 | VACUUM (ANALYZE)로 통계 생성 |
| High | 상점/초대 시드 | product / limited package / invite_code 기본 데이터 삽입 |
| High | shop_transactions 제약 정리 | 비합리적 UNIQUE (user_id, product_id) 제거 마이그레이션 준비 |
| Medium | follow_relations 제약 재설계 | 단일 UNIQUE 제거, 복합만 유지 |
| Medium | event_mission_links 중복 UNIQUE 정리 | pair 인덱스만 유지 |
| Medium | game_stats user_id NOT NULL | 무결성 강화 |
| Low | 세그먼트/RFM 초기값 정책 문서화 | 계산 배치 전 interim 값 정의 |

## 9. 향후 마이그레이션 초안
- Revision: consolidate_shop_tx_uniques
  - Drop INDEX / CONSTRAINT: shop_transactions_user_id_key, shop_transactions_product_id_key (정확 명칭 확인 필요)
  - Keep: uq_shop_tx_user_product_idem
- Revision: normalize_follow_relations_uniques
  - Drop UNIQUE on user_id, target_user_id
  - Keep / Add UNIQUE(user_id, target_user_id)
- Revision: cleanup_event_mission_links_uniques
  - Drop UNIQUE on event_id, mission_template_id
  - Keep pair unique
- Revision: enforce_not_null_game_stats_user
  - ALTER TABLE game_stats ALTER COLUMN user_id SET NOT NULL;

## 10. 핵심 테이블 스냅샷
| Table | Rows | 주요 인덱스 | 비고 |
|-------|------|-------------|------|
| users | 6 | PK, uniq(phone,nick,site) | 시드 완료 |
| user_segments | 6 | uniq(user_id) | OK |
| shop_products | 9 | uniq(product_id) | 기본 상품 시드 완료 |
| shop_limited_packages | 0 | uniq(package_id) | 시드 필요 |
| shop_transactions | 0 | 복수 UNIQUE 과다 | 정리 필요 |
| reward_audit | 0 | user_id+created_at | 추후 생성 |
| invite_codes | 1 | uniq(code) | 단일 코드 5858 시드 완료 |
| game_sessions | 0 | ext_session uniq | 로그 필요 |
| game_history | 0 | user_id, created_at | 로그 필요 |

## 11. 운영 점검 체크리스트 (이 문서 기준)
- [x] 상점 시드 적용 (9개 product)
- [x] 초대코드 시드 적용 (5858)
- [ ] 소셜/팔로우 UNIQUE 구조 재검토
- [ ] shop_transactions 제약 구조 마이그레이션 작성
- [ ] ANALYZE 전체 실행
- [ ] RFM 배치 계산 스크립트 초안 연결

## 12. 부록: 수집 원시 쿼리 (요약)
- Columns: SELECT ... FROM information_schema.columns
- PK/UNIQUE: information_schema.table_constraints JOIN key_column_usage
- FK: pg_constraint + pg_get_constraintdef
- Index: pg_index + pg_get_indexdef
- Rowcount 근사: pg_class.reltuples
- Exact 핵심: count(*) (users 등)

---
본 문서는 현재 구조 상태의 스냅샷이며, 위 권장 액션 수행 후 재생성해 변경 추적 필요.
